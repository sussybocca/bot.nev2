<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Friend Requests & Create Bot</title>
<style>
  body { font-family: Arial, sans-serif; background:#f9fafc; margin:0; padding:20px; text-align:center; }
  h1 { color:#333; }
  .profile-header { display:flex; align-items:center; justify-content:center; margin-bottom:20px; gap:15px; }
  .profile-header img { width:50px; height:50px; border-radius:50%; object-fit:cover; }
  .online { color:lime; font-weight:bold; }
  .offline { color:gray; font-weight:bold; }
  form { margin:20px auto; max-width:500px; background:#fff; padding:20px; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,0.1);}
  input, textarea, select, button { width:100%; margin-bottom:15px; padding:10px; font-size:14px; border-radius:5px; border:1px solid #ccc; }
  button { background:#007bff; color:white; border:none; cursor:pointer; }
  button:hover { background:#0056b3; }
  .output { margin-top:15px; font-family:monospace; padding:10px; border-radius:6px; }
  .output.success { background:#e6ffed; color:#256d1b; border:1px solid #8dd48a; }
  .output.error { background:#ffe6e6; color:#a12626; border:1px solid #f5a3a3; }
  .links-container { margin-top:25px; display:flex; justify-content:center; flex-wrap:wrap; gap:10px; }
  .links-container a { padding:8px 15px; background:#fff; border-radius:8px; text-decoration:none; color:#007bff; font-weight:bold; box-shadow:0 2px 5px rgba(0,0,0,0.1); transition:0.2s; }
  .links-container a:hover { background:#007bff; color:#fff; }
  #incomingRequests div { display:flex; align-items:center; justify-content:space-between; margin-bottom:10px; padding:5px; background:#fff; border-radius:5px; box-shadow:0 1px 3px rgba(0,0,0,0.1); }
  #incomingRequests div button { margin-left:5px; padding:3px 8px; }

  /* =========================
     CHAT FLOATING BUBBLE
     ========================= */
  #chatBubble {
    position: fixed;
    bottom: 20px;
    right: 20px;
    width: 64px;
    height: 64px;
    border-radius: 50%;
    background: #007bff;
    color: white;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    box-shadow: 0 4px 12px rgba(0,0,0,0.25);
    z-index: 9999;
  }
  #chatBubble span { font-size: 10px; margin-top: 2px; max-width: 55px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  #chatBadge { position: absolute; top: 6px; right: 6px; background: red; color: white; font-size: 10px; padding: 2px 6px; border-radius: 50%; display: none; }
</style>
</head>
<body>

<div class="profile-header" id="profile"></div>

<h1>ü§ñ Create Your Bot</h1>

<form id="botForm">
  <input type="text" id="botName" placeholder="Bot Name" required />
  <textarea id="description" placeholder="Describe your bot..." required></textarea>

  <label for="voiceSelect">Select Voice:</label>
  <select id="voiceSelect" required><option value="">Loading voices...</option></select>

  <label for="fbxSelect">Select FBX Model:</label>
  <select id="fbxSelect" required><option value="">Choose FBX Model</option></select>

  <input type="text" id="gumroadLink" placeholder="Optional Gumroad Link for paid model" />
  <button type="submit">Create Bot</button>
</form>

<div id="output" class="output"></div>

<h2>Incoming Friend Requests</h2>
<div id="incomingRequests"></div>

<input type="email" id="friendEmail" placeholder="Friend's Email">
<button id="sendRequestBtn">Send Friend Request</button>

<div class="links-container">
  <nav>
    <a href="/create.html?user=@scoobydo">‚öôÔ∏è Create a Bot</a>
    <a href="/marketplace.html?character=scoobydo">üõí Marketplace</a>
    <a href="/explore.html?user=@scoobydo">üîç Explore Bots</a>
    <a href="/index.html?user=@scoobydo">üè† Home</a>
    <a href="/login.html?redirect=user=@scoobydo">üîó Login</a>
    <a href="/signup.html?ref=@scoobydo">üéûÔ∏è Signup</a>
  </nav>
</div>

<div id="chatBubble" onclick="openChat()">
  üí¨
  <span id="chatUsername">Chat</span>
  <div id="chatBadge">!</div>
</div>

<script>
  // -----------------------
  // GET SESSION TOKEN
  // -----------------------
  function getSessionToken() {
    return document.cookie
      .split('; ')
      .find(row => row.startsWith('session_token='))
      ?.split('=')[1];
  }

  // -----------------------
  // PROFILE
  // -----------------------
  async function loadProfile() {
    try {
      const token = getSessionToken();
      if(!token) throw new Error('No session token found');
      const res = await fetch('/.netlify/functions/profileCreation', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ session_token: token })
      });
      const result = await res.json();
      if (!result.success) throw new Error(result.error || 'Failed to fetch user');

      const user = result.user;
      window.userEmail = user.email;

      const div = document.getElementById('profile');
      const online = (Date.now() - new Date(user.last_online)) < 5*60*1000 ? 'online' : 'offline';
      const avatarUrl = user.profile_picture?.startsWith('data:') 
        ? user.profile_picture 
        : `https://avatars.dicebear.com/api/initials/${encodeURIComponent(user.email)}.svg`;
      div.innerHTML = `
        <img src="${avatarUrl}" alt="Profile Picture" />
        <span>${user.username || user.email} - <span class="${online}">${online}</span></span>
      `;

      const chatUser = document.getElementById('chatUsername');
      if(chatUser) chatUser.textContent = user.username || user.email;

    } catch(e) {
      console.error('Failed to load profile', e);
    }
  }

  // -----------------------
  // FRIEND REQUESTS
  // -----------------------
  async function loadIncoming() {
    try {
      const token = getSessionToken();
      const res = await fetch('/.netlify/functions/friend-requests', {
        method:'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
          action:'list', 
          user_email: window.userEmail,
          session_token: token
        })
      });
      const data = await res.json();
      const container = document.getElementById('incomingRequests');
      container.innerHTML = '';
      data.forEach(req => {
        const div = document.createElement('div');
        div.innerHTML = `<span>${req.sender_email}</span>
          <button onclick="respond('${req.id}','accepted')">Accept</button>
          <button onclick="respond('${req.id}','rejected')">Reject</button>`;
        container.appendChild(div);
      });
    } catch(e) { console.error(e); }
  }

  window.respond = async (id,status)=>{
    const token = getSessionToken();
    const res = await fetch('/.netlify/functions/friend-requests', {
      method:'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ 
        action:'respond', 
        request_id:id, 
        status,
        session_token: token
      })
    });
    const data = await res.json();
    alert(data.success ? `Request ${status}` : data.error);
    loadIncoming();
  }

  document.getElementById('sendRequestBtn').addEventListener('click', async ()=>{
    const token = getSessionToken();
    const receiver_email = document.getElementById('friendEmail').value;
    const res = await fetch('/.netlify/functions/friend-requests',{
      method:'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ 
        action:'send', 
        sender_email:window.userEmail, 
        receiver_email,
        session_token: token
      })
    });
    const data = await res.json();
    alert(data.success ? 'Request sent!' : data.error);
    loadIncoming();
  });

  // -----------------------
  // BOT CREATION
  // -----------------------
  const form = document.getElementById('botForm');
  const output = document.getElementById('output');
  const voiceSelect = document.getElementById('voiceSelect');
  const fbxSelect = document.getElementById('fbxSelect');

  const createBotPath = '/.netlify/functions/overpoweredbot';
  const voicesPath = '/.netlify/functions/get-voices';

  async function loadVoices() {
    try{
      const token = getSessionToken();
      const res = await fetch(voicesPath, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ session_token: token })
      });
      const voices = await res.json();
      voiceSelect.innerHTML = '<option value="">Select Voice</option>';
      voices.forEach(v=>{
        const opt = document.createElement('option');
        opt.value=v.id;
        opt.textContent=`${v.name} (${v.lang})`;
        voiceSelect.appendChild(opt);
      });
    } catch(err){
      voiceSelect.innerHTML = '<option value="">Failed to load voices</option>';
      console.error(err);
    }
  }

  const fbxModels = [
    {id:'model1',name:'Humanoid Default'},
    {id:'model2',name:'Robot Model'}
  ];
  fbxModels.forEach(m=>{
    const opt = document.createElement('option');
    opt.value=m.id;
    opt.textContent=m.name;
    fbxSelect.appendChild(opt);
  });

  form.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const token = getSessionToken();
    const name = document.getElementById('botName').value.trim();
    const description = document.getElementById('description').value.trim();
    const voice_id = voiceSelect.value;
    const fbx_model_id = fbxSelect.value;
    const paid_link = document.getElementById('gumroadLink').value.trim();

    if(!name||!description||!voice_id||!fbx_model_id){
      output.textContent='Please fill all required fields.'; 
      output.className='output error'; 
      return;
    }

    output.textContent='Creating bot...'; 
    output.className='output';

    try{
      const res = await fetch(createBotPath,{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({ 
          name, description, voice_id, fbx_model_id, paid_link,
          session_token: token
        })
      });
      const data = await res.json();
      if(!res.ok || data.error){ 
        output.textContent=`Error: ${data.error||'Unknown'}`; 
        output.className='output error'; 
        return; 
      }
      output.innerHTML=`<strong>Bot Created Successfully!</strong><br>ID/Hash: ${data.id||'N/A'}<br>API Key: ${data.apiKey||'Check Backend'}<br>File: bot.js<br><br>
        <a href="/explore.html">üîç Explore</a> | <a href="/index.html">üè† Home</a>`;
      output.className='output success'; 
      form.reset();
    } catch(err){
      output.textContent='Failed to create bot.'; 
      output.className='output error';
    }
  });

  // -----------------------
  // CHAT NAV
  // -----------------------
  function openChat() {
    window.location.href = '/chat.html';
  }

  // -----------------------
  // INITIAL LOAD
  // -----------------------
  loadProfile().then(loadIncoming).then(loadVoices);
</script>

</body>
</html>
