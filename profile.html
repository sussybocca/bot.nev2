<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Create Profile</title>
<style>
body { font-family: Arial, sans-serif; padding: 20px; background: #f0f0f0; }
.container { max-width: 600px; margin: auto; background: #fff; padding: 20px; border-radius: 8px; }
.step { display: none; }
.step.active { display: block; }
input, textarea, select { width: 100%; padding: 8px; margin: 5px 0; }
button { padding: 10px 15px; margin-top: 10px; }
.fbx-options { display: flex; gap: 10px; flex-wrap: wrap; }
.fbx-options div { padding: 10px; border: 1px solid #ccc; cursor: pointer; border-radius: 5px; }
.fbx-options div.selected { border-color: #28a745; background: #e6ffe6; }
#message { margin-top:20px; color: #333; }
#profile-preview { max-width:150px; display:block; margin-top:10px; }
</style>
</head>
<body>
<div class="container">
<h1>Create Your Profile</h1>

<!-- Step 1 -->
<div class="step active" id="step-1">
  <h2>Step 1: Username & Bio</h2>
  <input type="text" id="username" placeholder="Username" />
  <textarea id="bio" placeholder="Your bio"></textarea>
  <button onclick="nextStep()">Next</button>
</div>

<!-- Step 2 -->
<div class="step" id="step-2">
  <h2>Step 2: Profile Picture</h2>
  <input type="file" id="profile-picture" accept="image/*" />
  <img id="profile-preview" />
  <button onclick="nextStep()">Next</button>
</div>

<!-- Step 3 -->
<div class="step" id="step-3">
  <h2>Step 3: Pick FBX Avatars (max 3)</h2>
  <div class="fbx-options" id="fbx-options">
    <div data-id="fbx1">Model 1</div>
    <div data-id="fbx2">Model 2</div>
    <div data-id="fbx3">Model 3</div>
    <div data-id="fbx4">Model 4</div>
  </div>
  <button onclick="nextStep()">Next</button>
</div>

<!-- Step 4 -->
<div class="step" id="step-4">
  <h2>Step 4: Finish</h2>
  <button onclick="finishProfile()">Complete Profile</button>
</div>

<div id="message"></div>
</div>

<script>
let currentStep = 1;
let fbxSelected = [];

// Session token from cookie
function getSessionToken() {
  const match = document.cookie.match(/session_token=([^;]+)/);
  return match ? match[1] : null;
}

// FBX selection
document.querySelectorAll('.fbx-options div').forEach(el => {
  el.addEventListener('click', () => {
    if(fbxSelected.includes(el.dataset.id)){
      fbxSelected = fbxSelected.filter(id=>id!==el.dataset.id);
      el.classList.remove('selected');
    } else if(fbxSelected.length < 3){
      fbxSelected.push(el.dataset.id);
      el.classList.add('selected');
    }
  });
});

// Show active step
function showStep(step){
  document.querySelectorAll('.step').forEach(s=>s.classList.remove('active'));
  const stepEl = document.getElementById(`step-${step}`);
  if(stepEl) stepEl.classList.add('active');
}

// Send step data to backend
async function sendStepData(step,data){
  const session_token = getSessionToken();
  if(!session_token) { alert("No session token found"); return; }

  const res = await fetch('/.netlify/functions/profileCreation',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({step,session_token,...data})
  });
  return await res.json();
}

// Next step
async function nextStep(){
  let data = {};

  if(currentStep===1){
    const username=document.getElementById('username').value.trim();
    const bio=document.getElementById('bio').value.trim();
    if(!username||!bio){ alert("Enter username and bio"); return; }
    data={username,bio};

  } else if(currentStep===2){
    const fileInput=document.getElementById('profile-picture');
    if(fileInput.files.length===0){ alert("Upload a profile picture"); return; }

    const file = fileInput.files[0];
    data.profile_picture = await new Promise((resolve,reject)=>{
      const reader = new FileReader();
      reader.onload = () => resolve(reader.result);
      reader.onerror = () => reject("Failed to read file");
      reader.readAsDataURL(file);
    });

    // Show preview
    document.getElementById('profile-preview').src = data.profile_picture;

  } else if(currentStep===3){
    if(fbxSelected.length===0){ alert("Select at least 1 FBX avatar"); return; }
    data = { fbx_avatar_ids: fbxSelected };
  }

  const response = await sendStepData(currentStep,data);
  document.getElementById('message').innerText = response.message || response.error;

  if(response.success){
    currentStep++;
    showStep(currentStep);
  }
}

// Finish profile
async function finishProfile(){
  const response = await sendStepData(currentStep,{});
  document.getElementById('message').innerText=response.message || response.error;

  if(response.success){
    alert("Profile created successfully!");
    window.location.href='/marketplace.html';
  }
}
</script>
</body>
</html>
