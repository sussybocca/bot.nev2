<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Secure Email System</title>
  <style>
    body { background-color: #0f0f0f; color: #00ff00; font-family: 'Courier New', monospace; margin: 0; padding: 0; }
    header { background-color: #111; padding: 20px; text-align: center; font-size: 1.5em; border-bottom: 2px solid #00ff00; }
    main { padding: 20px; display: flex; flex-direction: column; max-width: 700px; margin: auto; }
    label { display: block; margin: 10px 0 5px; font-weight: bold; }
    select, input, textarea { width: 100%; padding: 8px; background-color: #111; border: 1px solid #00ff00; color: #00ff00; font-family: monospace; }
    textarea { height: 150px; resize: vertical; }
    button { margin-top: 15px; padding: 10px 20px; background-color: #ff0000; color: #000; border: none; cursor: pointer; font-weight: bold; transition: 0.2s; }
    button:hover { background-color: #aa0000; }
    #output { margin-top: 20px; padding: 10px; border: 1px solid #00ff00; min-height: 20px; white-space: pre-wrap; }
    #inbox { margin-top: 30px; }
    .email { border: 1px solid #00ff00; padding: 10px; margin-bottom: 10px; }
    .email strong { display: inline-block; width: 80px; }
  </style>
</head>
<body>
  <header>Secure Email System</header>
  <main>
    <label for="toUser">Send To:</label>
    <select id="toUser">
      <option value="">Loading users...</option>
    </select>

    <label for="subject">Subject:</label>
    <input type="text" id="subject" placeholder="Type subject here...">

    <label for="body">Body:</label>
    <textarea id="body" placeholder="Type your email..."></textarea>

    <button id="sendBtn">Send Email</button>
    <div id="output"></div>

    <h2>Inbox</h2>
    <div id="inbox">Loading emails...</div>
  </main>

  <script>
    const toUserSelect = document.getElementById('toUser');
    const subjectInput = document.getElementById('subject');
    const bodyInput = document.getElementById('body');
    const sendBtn = document.getElementById('sendBtn');
    const output = document.getElementById('output');
    const inboxDiv = document.getElementById('inbox');

    const CSRF_TOKEN = '<?=process.env.CSRF_TOKEN?>'; // Or set dynamically

    // Helper: fetch with credentials
    async function fetchWithCredentials(url, options = {}) {
      options.credentials = 'include'; // <--- send cookies
      return fetch(url, options);
    }

    // Load verified users
    async function loadUsers() {
      try {
        const res = await fetchWithCredentials('/.netlify/functions/getVerifiedUsers', {
          method: 'POST',
          headers: { 'x-csrf-token': CSRF_TOKEN }
        });
        const data = await res.json();
        if (!data.success) {
          toUserSelect.innerHTML = '<option value="">Failed to load users</option>';
          return;
        }
        toUserSelect.innerHTML = '<option value="">Select recipient...</option>';
        data.users.forEach(u => {
          const option = document.createElement('option');
          option.value = u.email;
          option.textContent = u.email;
          toUserSelect.appendChild(option);
        });
      } catch (err) {
        toUserSelect.innerHTML = '<option value="">Error loading users</option>';
        console.error('loadUsers error:', err);
      }
    }

    // Load inbox emails
    async function loadInbox() {
      try {
        inboxDiv.textContent = 'Loading emails...';
        const res = await fetchWithCredentials('/.netlify/functions/getEmails', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'x-csrf-token': CSRF_TOKEN }
        });
        const data = await res.json();
        if (!data.success) {
          inboxDiv.textContent = 'Failed to load emails';
          return;
        }
        if (!data.emails || data.emails.length === 0) {
          inboxDiv.textContent = 'No emails';
          return;
        }
        inboxDiv.innerHTML = '';
        data.emails.forEach(e => {
          const emailDiv = document.createElement('div');
          emailDiv.className = 'email';
          emailDiv.innerHTML = `
            <div><strong>From:</strong> ${e.from_user}</div>
            <div><strong>Subject:</strong> ${e.subject || '(No subject)'}</div>
            <div><strong>Received:</strong> ${new Date(e.created_at).toLocaleString()}</div>
            <div>${e.body}</div>
          `;
          inboxDiv.appendChild(emailDiv);
        });
      } catch (err) {
        inboxDiv.textContent = 'Error loading emails';
        console.error('loadInbox error:', err);
      }
    }

    // Send email
    sendBtn.addEventListener('click', async () => {
      const to_user = toUserSelect.value;
      const subject = subjectInput.value.trim();
      const body = bodyInput.value.trim();

      if (!to_user || !body) {
        output.textContent = 'Recipient and body are required!';
        return;
      }

      try {
        const res = await fetchWithCredentials('/.netlify/functions/sendEmail', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'x-csrf-token': CSRF_TOKEN },
          body: JSON.stringify({ to_user, subject, body })
        });
        const data = await res.json();
        if (data.success) {
          output.textContent = 'Email sent successfully!';
          subjectInput.value = '';
          bodyInput.value = '';
          loadInbox(); // refresh inbox
        } else {
          output.textContent = 'Error: ' + (data.error || 'Unknown error');
        }
      } catch (err) {
        output.textContent = 'Error sending email';
        console.error('sendEmail error:', err);
      }
    });

    // Initial load
    loadUsers();
    loadInbox();
  </script>
</body>
</html>
