<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Chat</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>

<style>
body {
  font-family: Arial, sans-serif;
  margin: 0;
  display: flex;
  height: 100vh;
}

/* Sidebar */
#sidebar {
  width: 260px;
  background: #f4f4f4;
  padding: 10px;
  overflow-y: auto;
  border-right: 1px solid #ccc;
}

.chat-item {
  padding: 10px;
  cursor: pointer;
  border-bottom: 1px solid #ddd;
  border-radius: 5px;
}

.chat-item:hover {
  background: #ddd;
}

/* Chat area */
#chatArea {
  flex: 1;
  display: flex;
  flex-direction: column;
}

#chatHeader {
  padding: 10px;
  border-bottom: 1px solid #ccc;
  background: #fafafa;
  font-weight: bold;
}

#messages {
  flex: 1;
  padding: 10px;
  overflow-y: auto;
}

/* Message bubbles */
.message {
  margin-bottom: 10px;
  padding: 8px;
  border-radius: 6px;
  max-width: 70%;
  background: #e9e9e9;
}

.message.you {
  background: #d0ebff;
  margin-left: auto;
}

.meta {
  font-size: 11px;
  color: #555;
}

/* Input */
#inputBar {
  display: flex;
  padding: 10px;
  border-top: 1px solid #ccc;
}

#inputBar input {
  flex: 1;
  padding: 8px;
}

#inputBar button {
  margin-left: 5px;
}
</style>
</head>

<body>

<!-- SIDEBAR -->
<div id="sidebar">
  <h3>Chats</h3>
  <div id="chatList">Loading‚Ä¶</div>

  <hr>
  <button onclick="openReactions()">üëç Reactions</button>
  <button onclick="openFiles()">üìÅ Files</button>
  <button onclick="openBots()">ü§ñ Bots</button>
  <button onclick="toggleMute()">üîï Mute/Archive</button>
  <button onclick="kickUser()">üö´ Kick User</button>
  <button onclick="renameChat()">‚úèÔ∏è Rename Chat</button>
</div>

<!-- CHAT AREA -->
<div id="chatArea">
  <div id="chatHeader">Select a chat</div>
  <div id="messages"></div>

  <div id="inputBar">
    <input id="msgInput" placeholder="Type a message‚Ä¶" />
    <button onclick="sendMessage()">Send</button>
  </div>
</div>

<script>
/* -----------------------
   SUPABASE SETUP
----------------------- */
// /.netlify/functions/_supabase.js
import { createClient } from '@supabase/supabase-js';

export const supabase = createClient(
  process.env.SUPABASE_URL,
  process.env.SUPABASE_SERVICE_KEY // Use a service role key in env, never frontend
);


let conversationId = null;
let channel = null;
let myUserId = null;

/* -----------------------
   INIT USER
----------------------- */
async function initUser() {
  try {
    const res = await fetch('/.netlify/functions/profileCreation', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ session_token: getToken() })
    });
    const data = await res.json();
    myUserId = data.user.id;
  } catch {
    alert("Failed to load user. Check session or backend.");
  }
}

initUser();

/* -----------------------
   LOAD CHAT LIST
----------------------- */
async function loadChats() {
  try {
    const res = await fetch('/.netlify/functions/chat-list?session_token=' + getToken());
    const chats = await res.json();
    const list = document.getElementById('chatList');
    list.innerHTML = '';

    chats.forEach(c => {
      const div = document.createElement('div');
      div.className = 'chat-item';
      div.textContent = c.conversations.title || 'Private Chat';
      div.onclick = () => openChat(c.conversation_id, div.textContent);
      list.appendChild(div);
    });
  } catch {
    alert("Failed to load chats. Backend may not exist.");
  }
}

/* -----------------------
   OPEN CHAT
----------------------- */
async function openChat(id, title) {
  conversationId = id;
  document.getElementById('chatHeader').textContent = title;
  document.getElementById('messages').innerHTML = '';
  await loadMessages();
  startRealtime();
}

/* -----------------------
   LOAD MESSAGES
----------------------- */
async function loadMessages() {
  try {
    const res = await fetch(`/.netlify/functions/chat-messages?id=${conversationId}`);
    const msgs = await res.json();
    msgs.forEach(renderMessage);
  } catch {
    alert("Failed to load messages. Backend may not exist.");
  }
}

/* -----------------------
   REALTIME
----------------------- */
function startRealtime() {
  if (channel) supabase.removeChannel(channel);

  channel = supabase
    .channel('chat-' + conversationId)
    .on(
      'postgres_changes',
      { event: 'INSERT', schema: 'public', table: 'messages' },
      payload => renderMessage(payload.new)
    )
    .subscribe();
}

/* -----------------------
   SEND MESSAGE
----------------------- */
async function sendMessage() {
  const input = document.getElementById('msgInput');
  if (!input.value || !conversationId) return;

  try {
    await fetch('/.netlify/functions/chat-send', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({
        session_token: getToken(),
        conversation_id: conversationId,
        content: input.value
      })
    });
    input.value = '';
  } catch {
    alert("Failed to send message. Backend may not exist.");
  }
}

/* -----------------------
   RENDER MESSAGE
----------------------- */
function renderMessage(msg) {
  const div = document.createElement('div');
  div.className = 'message' + (msg.sender_id === myUserId ? ' you' : '');
  const time = new Date(msg.created_at).toLocaleTimeString();
  div.innerHTML = `<div>${msg.content}</div><div class="meta">${time}</div>`;
  document.getElementById('messages').appendChild(div);
  document.getElementById('messages').scrollTop = 999999;
}

/* -----------------------
   TOKEN HELPER
----------------------- */
function getToken() {
  return document.cookie
    .split('; ')
    .find(r => r.startsWith('session_token='))?.split('=')[1];
}

/* -----------------------
   EXTRA FEATURES
----------------------- */
async function openReactions() {
  try {
    await fetch('/.netlify/functions/chat-reactions?conversation_id=' + conversationId);
  } catch {
    alert("Reactions feature not available. Backend/table missing.");
  }
}

async function openFiles() {
  try {
    await fetch('/.netlify/functions/chat-files?conversation_id=' + conversationId);
  } catch {
    alert("Files feature not available. Backend/table missing.");
  }
}

async function openBots() {
  try {
    await fetch('/.netlify/functions/chat-bots?conversation_id=' + conversationId);
  } catch {
    alert("Bots feature not available. Backend/table missing.");
  }
}

async function toggleMute() {
  if (!conversationId) return;
  try {
    await fetch('/.netlify/functions/chat-mute', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ session_token: getToken(), conversation_id: conversationId })
    });
    alert("Chat muted/unmuted");
  } catch {
    alert("Mute feature backend/table missing.");
  }
}

async function kickUser() {
  const userId = prompt("Enter User ID to kick:");
  if (!userId || !conversationId) return;
  try {
    await fetch('/.netlify/functions/chat-kick', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ session_token: getToken(), conversation_id: conversationId, target_user_id: userId })
    });
    alert("Kick request sent");
  } catch {
    alert("Kick feature backend/table missing.");
  }
}

async function renameChat() {
  const newTitle = prompt("Enter new chat name:");
  if (!newTitle || !conversationId) return;
  try {
    await fetch('/.netlify/functions/chat-rename', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ session_token: getToken(), conversation_id: conversationId, new_title: newTitle })
    });
    document.getElementById('chatHeader').textContent = newTitle;
    alert("Rename request sent");
  } catch {
    alert("Rename feature backend/table missing.");
  }
}

loadChats();
</script>

</body>
</html>
