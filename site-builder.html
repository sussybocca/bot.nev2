<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Botnet2 Site Builder</title>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.0/dist/jszip.min.js"></script>
  <script type="module" src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/supabase.min.js"></script>
  <style>
    body { font-family: sans-serif; background: #111; color: white; padding: 20px; }
    input, button { padding: 10px; margin: 10px 0; width: 100%; }
    iframe { width: 100%; height: 400px; border: 1px solid #333; margin-top: 20px; }
  </style>
</head>
<body>

<h1>Botnet2 Site Builder</h1>
<p>Your site will live at: <strong>https://&lt;site-name&gt;.botnet2.netlify.app</strong></p>

<input type="text" id="siteName" placeholder="Enter site name (letters, numbers, -)" />
<input type="file" id="zipFile" accept=".zip" />
<button id="createSiteBtn">Create Site</button>

<iframe id="previewFrame"></iframe>

<script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/supabase.min.js';

  // Initialize Supabase (keys should be safe, do not push publicly)
  const supabase = createClient(
    process.env.SUPABASE_URL,
  process.env.SUPABASE_KEY
  );

  const zipInput = document.getElementById('zipFile');
  const siteNameInput = document.getElementById('siteName');
  const createBtn = document.getElementById('createSiteBtn');
  const previewFrame = document.getElementById('previewFrame');

  createBtn.addEventListener('click', async () => {
    const siteName = siteNameInput.value.trim();
    const file = zipInput.files[0];
    if (!siteName || !file) {
      alert('Please provide site name and ZIP file.');
      return;
    }
    if (!/^[a-z0-9-]{3,30}$/.test(siteName)) {
      alert('Site name invalid. Only lowercase letters, numbers, and - allowed.');
      return;
    }

    try {
      // 1️⃣ Register the site with create-site function
      const response = await fetch('/.netlify/functions/create-site', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ user_id: 'demo-user-id', site_name: siteName })
      });
      const data = await response.json();
      if (!data.success) {
        alert(data.error || 'Failed to create site');
        return;
      }

      // 2️⃣ Extract ZIP and upload files to Supabase Storage
      const zip = await JSZip.loadAsync(file);
      for (const [filename, zipEntry] of Object.entries(zip.files)) {
        if (zipEntry.dir) continue;
        // Only allow web files
        if (!/\.(html|css|js|png|jpg|jpeg|svg|json)$/.test(filename)) continue;
        const content = await zipEntry.async('arraybuffer');
        await supabase.storage
          .from('sites')
          .upload(`${siteName}/${filename}`, content, { upsert: true });
      }

      // 3️⃣ Preview site (serve-site function handles serving automatically)
      alert(`Site created! Visit: ${data.url}`);
      previewFrame.src = data.url;

    } catch (err) {
      console.error(err);
      alert('Error creating site or uploading files.');
    }
  });
</script>

</body>
</html>
