<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Fire-USA Site Builder</title>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.0/dist/jszip.min.js"></script>
  <style>
    body { font-family: sans-serif; background: #111; color: white; padding: 20px; }
    input, button { padding: 10px; margin: 10px 0; width: 100%; }
    iframe { width: 100%; height: 400px; border: 1px solid #333; margin-top: 20px; }
  </style>
</head>
<body>

<h1>Fire-USA Site Builder</h1>
<p>Your site will live at: <strong>https://&lt;site-name&gt;.fire-usa.com</strong></p>

<input type="text" id="siteName" placeholder="Enter site name (letters, numbers, -)" />
<input type="file" id="zipFile" accept=".zip" />
<input type="text" id="githubToken" placeholder="Enter your GitHub OAuth token" />
<button id="createSiteBtn">Create Site</button>

<iframe id="previewFrame"></iframe>

<script type="module">
  const zipInput = document.getElementById('zipFile');
  const siteNameInput = document.getElementById('siteName');
  const githubTokenInput = document.getElementById('githubToken');
  const createBtn = document.getElementById('createSiteBtn');
  const previewFrame = document.getElementById('previewFrame');

  createBtn.addEventListener('click', async () => {
    const siteName = siteNameInput.value.trim();
    const file = zipInput.files[0];
    const githubToken = githubTokenInput.value.trim();

    if (!siteName || !file || !githubToken) {
      alert('Please provide site name, ZIP file, and GitHub OAuth token.');
      return;
    }

    if (!/^[a-z0-9-]{3,30}$/.test(siteName)) {
      alert('Site name invalid. Only lowercase letters, numbers, and - allowed.');
      return;
    }

    try {
      // Extract ZIP contents
      const jszip = new JSZip();
      const zipData = await jszip.loadAsync(file);
      const files = {};

      await Promise.all(Object.keys(zipData.files).map(async (filename) => {
        if (!zipData.files[filename].dir) {
          const content = await zipData.files[filename].async('text');
          files[filename] = content;
        }
      }));

      // Send JSON to create-site function
      const response = await fetch('/.netlify/functions/create-site', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          site_name: siteName,
          files,
          github_token: githubToken
        })
      });

      const data = await response.json();

      if (!data.success) {
        alert(data.error || 'Failed to create site');
        return;
      }

      alert(`Site created! GitHub repo: ${data.githubUrl}`);
      previewFrame.src = `https://${siteName}.fire-usa.com`;

    } catch (err) {
      console.error('Error creating site:', err);
      alert('Error creating site. Check console for details.');
    }
  });
</script>

</body>
</html>
